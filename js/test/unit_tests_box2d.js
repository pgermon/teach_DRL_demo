const FPS = 50
const SCALE  = 30 // affects how fast-paced the game is, forces should be adjusted as well
const VIEWPORT_W = 1300
const VIEWPORT_H = 350
const WATER_DENSITY = 1.0
const HULL_POLYGON = [[-30, +9], [+6, +9], [+34, +1], [+34, -8], [-30, -8]];

class TestEnvironment {
    constructor(){
        this.scale  = SCALE;
        let gravity = new b2.Vec2(0, -10);
        this.world = new b2.World(gravity);
        this.max_steps = 10000;

        this.terrain = [];

        this.water_dynamics = new WaterDynamics(this.world.m_gravity);
        this.agent_body = new ClassicBipedalBody(this.scale);
        //this.agent_body = new TestBody(this.scale);

        this.actions_seq = [];

        this.reset();
    }

    _destroy(){
        this.world.contactListener = null;
        for(let t of this.terrain){
            this.world.DestroyBody(t);
        }
        this.terrain = [];
        this.creepers_joints = [];
        this.agent_body.destroy(this.world);
    }

    reset(){
        this._destroy();
        this.world.contactListener_bug_workaround = new ContactDetector(this);
        this.world.SetContactListener(this.world.contactListener_bug_workaround);

        this.generate_terrain();
        this.generate_agent();
        this.generate_actions_sequence();

        this.run();
    }

    step(action){
        if(action != null){
            this.agent_body.activate_motors(action);
        }
        this.world.Step(1.0 / FPS, 6 * 30, 2 * 30);
        this.water_dynamics.calculate_forces(this.world.m_contactManager.m_contactListener.water_contact_detector.fixture_pairs);
    }

    generate_terrain(){
        this.generate_water();
        this.generate_ground();
    }

    generate_water(){
        // Water
        let fd_water = new b2.FixtureDef();
        fd_water.shape = new b2.PolygonShape();
        fd_water.shape.SetAsBox(100, 100);
        fd_water.density = WATER_DENSITY;
        fd_water.isSensor = true;
        let water_bd = new b2.BodyDef();
        water_bd.type = b2.Body.b2_staticBody;
        water_bd.position.Set(0, -110);
        let water = this.world.CreateBody(water_bd);
        water.CreateFixture(fd_water);
        water.SetUserData(new CustomUserData("water", CustomUserDataObjectTypes.WATER));
        this.terrain.push(water);
    }

    generate_ground(){
        // Ground
        let fd_ground = new b2.FixtureDef();
        fd_ground.shape = new b2.PolygonShape();
        fd_ground.shape.SetAsBox(100, 2);
        let ground_bd = new b2.BodyDef();
        ground_bd.type = b2.Body.b2_staticBody;
        ground_bd.position.Set(0, -10);
        //ground_bd.angle = Math.PI/4;
        let ground = this.world.CreateBody(ground_bd);
        ground.CreateFixture(fd_ground);
        ground.SetUserData(new CustomUserData("ground", CustomUserDataObjectTypes.TERRAIN));
        this.terrain.push(ground)
    }

    generate_agent(){
        let init_x = 0;
        let init_y = 0;
        this.agent_body.draw(this.world, init_x, init_y, 0);
    }

    generate_actions_sequence(self){
        /*this.actions_seq = [];
        for(let i = 0; i < this.max_steps; i++){
            this.actions_seq.push(Array.from({length: this.agent_body.get_action_size()}, () => Math.random() * 2 - 1));
        }*/

        this.actions_seq = [
            [0.5631325889248564, 0.35744988473850725, 0.18225167924685115, 0.35691084641330395],
            [-0.33056606418046997, -0.16798625665133526, 0.554461234452531, 0.2883036214645456],
            [-0.912285468403808, -0.805314608652278, -0.12011781026838886, 0.4377488647463985],
            [-0.803081794048401, -0.9887960848143984, -0.7909917807138416, 0.5296911824373058],
            [-0.11937268664709233, -0.46956826693359766, 0.3939789544700152, 0.2581713949455584],
            [-0.1133617441102932, -0.33640873010709127, -0.27175534448588357, 0.35289231401120347],
            [-0.15117726034514156, 0.6905722859424741, -0.007662821771521333, 0.02996924958302216],
            [-0.7804930500774914, -0.16495443398776644, 0.8269781164139038, -0.6047771706425058],
            [-0.03931125837165883, -0.3900036751691687, 0.02484529447153605, 0.5172155043620386],
            [-0.9435781779364554, -0.006562059613068882, 0.8879832119909987, -0.407208735700741],
            [0.880711148443925, 0.49293280044913246, 0.022101593637998018, 0.3671130120702122],
            [0.29924429430689603, 0.11847818605888394, 0.5696859076144176, -0.20483037639858503],
            [-0.5356992275445389, -0.9996255946671151, -0.6717331247390064, 0.8277222551195402],
            [0.343436576439454, -0.3313765306297354, -0.24474391453061806, 0.636211369499653],
            [-0.7528420254752253, 0.98808769947322, -0.8527252795069837, 0.8529622569254487],
            [-0.12780176073844984, 0.21718790559244683, -0.16594159656672636, 0.48669750919678423],
            [-0.10819133495958155, -0.7441756903847914, 0.10344502296934488, 0.4210527170441578],
            [0.040232596914999696, 0.4479080527900705, -0.2441372008057563, 0.7004837991991262],
            [-0.45130848947630753, -0.4055939134859514, 0.5512837886291315, -0.3010070733804908],
            [-0.14214016296693588, 0.43044245585916485, 0.9065599877963275, -0.8098510845867346],
            [0.9619486550716503, 0.4646364078459393, -0.23970267080092578, 0.13028223302221997],
            [0.7724182783953233, 0.8542996935212348, -0.7056047523744455, 0.30093918596059765],
            [0.8997400850111861, -0.694169653074451, -0.15261871323566156, 0.6149879748855818],
            [0.5859674008160591, -0.034729601600932636, 0.5687006640017458, 0.047327806505051306],
            [-0.3534891344424711, -0.8788247450255318, 0.5052811186154438, -0.8102887054857817],
            [0.07891090492495678, 0.6359525352858171, 0.37336586854317844, -0.014610290011090932],
            [-0.6014745506336858, 0.36677167175310776, -0.8505729298899811, -0.739443633197808],
            [-0.39572942338006234, 0.37250203237372137, -0.49290451210104314, 0.7035198707967978],
            [0.6594603793239306, -0.6906754579896468, 0.8154201764883884, -0.8452220298062514],
            [-0.8732516955013869, 0.24561777387470807, -0.10726666725354672, -0.6267881962107289],
            [-0.36869786930448845, -0.5417951888605543, 0.02484414845395788, 0.5334979274833707],
            [-0.05564874454607871, 0.3905040741830974, -0.557885411675958, 0.9495867350177352],
            [-0.2906135061404229, -0.7648449564840534, -0.033204734865842855, -0.6165069745038156],
            [-0.507102856649519, -0.8757657987011487, 0.23524300654301245, 0.19741392949819048],
            [-0.27533618025554407, 0.9818563984301534, 0.9327226486623896, -0.7355160311978208],
            [0.10826810764491901, -0.19550757578356137, -0.33725363019567833, -0.494167698015175],
            [0.07515898156643885, 0.5533049255137348, 0.48805664592136555, -0.08712338241807638],
            [-0.2608915378988059, -0.2519539687861694, -0.31343380476201466, -0.4414750792670237],
            [0.5354802199519462, -0.6620207645845873, 0.6855578944389631, -0.42687041510893353],
            [-0.7678338259729109, 0.9655541623823929, 0.8365059021818326, -0.904205057046326],
            [-0.5755475004929713, -0.8935534435172352, -0.14918009277686517, 0.9062751729771223],
            [0.8571880956856592, -0.51478835228813, 0.15995485321837943, 0.9904118372634438],
            [-0.20171140453451608, -0.4500756575429623, -0.7302546475159835, 0.9307791178838567],
            [-0.1854069848768818, 0.26465111833763233, -0.31322702923792534, 0.2505744305474731],
            [-0.27653988136144303, 0.24520430333406873, -0.7256212524144483, -0.590854756408417],
            [-0.7654666814298223, 0.1102649311317716, -0.9035862420602103, 0.8638027728128397],
            [-0.9867155817723376, 0.569845475091352, 0.8150928328666018, -0.9040488778393265],
            [0.11238060378981274, 0.24957950491590664, -0.8226724477273075, 0.5449152709884371],
            [-0.7193436763427372, -0.07792936234418635, 0.13171667346204607, -0.028741692628545756],
            [0.7410674563911428, -0.9035514157103326, 0.4042366456608124, -0.8350625829966836],
            [0.6471875798523024, -0.4265647989902641, 0.9110017858133812, 0.30422189370812003],
            [-0.6522008190529927, 0.7402177646695423, 0.8451154512262811, 0.5080568675032566],
            [-0.8823785463662088, 0.9127410006000902, 0.8604626860226827, 0.14897430865147543],
            [0.14631675140316736, 0.1731120566969233, 0.8676433373362511, 0.2079517577965868],
            [-0.6663645811916545, -0.5022595975348669, -0.9148518742029372, -0.8546235190860934],
            [-0.5809161236062712, -0.11765448021615788, 0.13486715042122777, -0.9790852338819005],
            [0.7158601957453503, 0.1851237553576861, -0.05122155939590867, 0.16047989790009565],
            [-0.722786711060396, -0.8807082840156126, -0.06102148810466668, -0.7528439975923695],
            [0.5702096665561229, 0.2539995832959643, 0.11479852237307009, -0.8881768878688043],
            [-0.6938536988527249, -0.04978530027706407, -0.9488839283377501, -0.7688025508631817],
            [0.6969351192537725, 0.42102037487108745, 0.6863781763745225, 0.0017838198782764714],
            [-0.8023704749847131, -0.7714806756055608, -0.4632088535058321, -0.2463564337130455],
            [-0.4443038963803434, -0.9660277040118319, 0.02708715206083978, -0.9372540571241728],
            [-0.08542752411664134, -0.526693172754229, -0.038019871714325415, 0.307557077064748],
            [0.6912772693013651, 0.6563729449479925, -0.6429311914410922, -0.5109642081345629],
            [0.12311091733419355, 0.10030728350156792, -0.08662331850337068, -0.5663500281554685],
            [0.9019026012173819, -0.884836962164298, -0.9210507945704483, -0.5376040343785418],
            [-0.4789325115033609, -0.7206842057739928, -0.5886868631093836, -0.9978477739351272],
            [-0.43898929360048466, 0.10912461066022461, 0.33301314767118884, -0.8729657613826487],
            [0.05302697063347672, 0.08523657581277577, 0.11223113768595905, -0.086065664598868],
            [-0.4893823303362148, 0.8789531636346744, -0.6259010748753573, 0.35124646461275555],
            [0.9426516254873509, -0.8464907929467169, -0.03824411325202215, -0.42709752739739804],
            [0.14162555377286967, 0.8424015498300572, -0.7087990374231006, 0.12240177509183203],
            [-0.7284520788287172, -0.976329641011966, 0.43108501183609604, 0.7579968768849721],
            [-0.26180791078151744, -0.4700274498413406, -0.8889796551126916, -0.9123944576521179],
            [0.9022231013488486, 0.6580214914313718, 0.5171210518713267, 0.22699082924026026],
            [0.675617345861645, -0.8201386067621685, 0.5178675681456619, -0.7955491995386739],
            [0.29137408469204207, 0.8687613758484409, 0.8547345764235397, 0.3784362544719726],
            [0.8810717294170987, -0.9981827134697476, 0.843121792271341, 0.8674864814142809],
            [-0.7486281052176733, 0.12474197161790945, 0.06365792347441124, -0.3100995126994568],
            [-0.2825764308228029, -0.24586429901812767, -0.16366903448959036, 0.19701470689555256],
            [-0.5795712993285465, -0.7228375527883233, 0.6499301843376522, -0.27264197420822933],
            [0.6203442228063425, -0.8040710581368025, 0.06705674426655239, 0.7633267494006142],
            [-0.199779973087844, -0.8044036339847169, -0.1845083022239078, 0.8382367138989726],
            [-0.6190770380961252, 0.09019215405813297, -0.1109369299157974, 0.5194368886120411],
            [-0.2563662709471286, -0.8724592803027345, -0.659097100729217, 0.10432474936321912],
            [0.7672901794392777, 0.05640266121224213, 0.4202894724534523, -0.7461199587741447],
            [-0.09369519194776554, -0.4767639427167878, 0.9623250494105533, -0.49651027317275176],
            [0.7773695819766342, 0.9827218933315325, 0.41599504227020034, -0.9012467224772367],
            [0.5072182355815453, -0.49627076442582396, -0.7653115702680604, -0.7199622414477762],
            [0.04031985344474709, -0.4034340580205509, 0.22489412663080977, 0.4243682387925083],
            [0.7062694886698591, 0.716640166517442, -0.21832456643408316, -0.5497473421616603],
            [0.5504974386223602, 0.3689456739764587, 0.743830135538821, 0.4388136343604345],
            [0.5419894775878062, -0.9802235365029244, -0.5033643317646632, 0.8374971953846302],
            [-0.2801264445065339, 0.0538309085695694, -0.936508459129306, 0.6661723512478099],
            [-0.2641705243928447, 0.5598850986409185, 0.19333347507214604, -0.9511536719883051],
            [-0.09492613640570857, -0.7463051472995366, 0.5587319323268716, -0.17904935878665196],
            [-0.7756734619378847, 0.6062652396228976, 0.6821086466210988, 0.26854866048437476],
            [-0.7990497530841338, 0.5332869288015818, 0.6557939183381185, 0.16134369660474635],
            [-0.02727359921287764, -0.019146303034001555, 0.9192113770637627, -0.8348644701499124]
        ]
    }

    run(){
        for(let i = 0; i < this.max_steps; i++){
            if(i < this.actions_seq.length){
                this.step(this.actions_seq[i]);
            }
            else{
                this.step(null);
            }
        }
        let positions = this.agent_body.get_parts_position();
        console.log(positions);
    }
}