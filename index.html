<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-zoom=1">
    <title>Deep Reinforcement Learning Interactive Demo</title>

    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>

    <!--<script defer src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@3.3.0/dist/tf-core.min.js"></script>-->

    <script defer src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"></script>

    <script defer src="https://cdn.jsdelivr.net/npm/p5@1.2.0/lib/p5.js"></script>

    <!--SCRIPTS DEPENDENCIES-->
    <script defer src="./js/box2d.js">  </script>
    <script defer src="./js/config.js"></script>

    <script defer src="js/Box2D_dynamics/water_dynamics.js"></script>
    <script defer src="js/Box2D_dynamics/climbing_dynamics.js"></script>
    <script defer src="js/Box2D_dynamics/contact_detector.js"></script>
    <script defer src="./js/utils/custom_user_data.js"></script>

    <script defer src ="./js/bodies/bodies_enum.js"></script>
    <script defer src ="./js/bodies/abstract_body.js"></script>
    <script defer src ="./js/bodies/walker_abstract_body.js"></script>
    <script defer src ="./js/bodies/old_classic_bipedal_body.js"></script>
    <script defer src ="./js/bodies/classic_bipedal_body.js"></script>

    <script defer src ="js/CPPN/cppn.js"></script>
    <script defer src="js/envs/parametric_continuous_parkour.js"></script>
    <!--<script defer src="js/envs/parametric_continuous_flat_parkour.js"></script>-->
    <script defer src="./js/parkour_game.js"></script>
    <script defer src="./js/draw_p5js.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.min.css">
    <link rel="stylesheet" href="./demo.css"></style>
</head>

<body>
<section class="section">

    <h1 class="title has-text-centered">Deep Reinforcement Learning Interactive Demo</h1>

    <div id="canvas_container">
        <!--<canvas id="main_screen2" width="1300" height="350" style="background-color: lightgrey" ></canvas>-->
    </div>


    <div>
        <div class="buttonscontainer ib">
            <button id="runButton"> Start </button>
            <button id="resetButton"> Reset Simulation </button>
        </div>

        <div class="buttonscontainer ib">
            <button id="followAgentButton"> Follow agent </button>
        </div>

        <div class="buttonscontainer ib">
            <button id="jointsButton"> Draw joints </button>
            <button id="lidarsButton"> Draw lidars </button>
        </div>
    </div>

    <hr>

    <div class="ib">
        <div>
            <p>Horizontal scroll:</p>
            <input type="range" min="0" max="100" value="0" class="slider" id="hScrollSlider">
            <!--<span id="hScrollValue"></span>-->
            <button id="resetHScroll">Reset</button>
        </div>

        <div>
            <p>Vertical scroll:</p>
            <input type="range" min="-50" max="100" value="0" class="slider" id="vScrollSlider">
            <!--<span id="vScrollValue"></span>-->
            <button id="resetVScroll">Reset</button>
        </div>

        <div>
            <p>Zoom:</p>
            <input type="range" min="0.3" max="1.25" value="1" class="slider" id="zoomSlider">
            <span id="zoomValue"></span>
            <button id="resetZoom">Reset</button>
        </div>
    </div>

    <div class="ib">
        <h1> <strong>Parkour Generation</strong>  </h1>
        <div class="ib">
            <p>Terrain shape:</p>
            <div class="slidecontainer">
                <input type="range" min="-1" max="1" value="0" class="slider" id="dim1Slider">
                <span id="dim1Value"></span>
            </div>
            <div class="slidecontainer">
                <input type="range" min="-1" max="1" value="0" class="slider" id="dim2Slider">
                <span id="dim2Value"></span>
            </div>
            <div class="slidecontainer">
                <input type="range" min="-1" max="1" value="0" class="slider" id="dim3Slider">
                <span id="dim3Value"></span>
            </div>
            <div class="slidecontainer">
                <span>Smoothing: </span>
                <input type="range" min="10" max="20" value="15" class="slider" id="smoothingSlider">
                <span id="smoothingValue"></span>
            </div>
            <div class="slidecontainer">
                <span>Water level: </span>
                <input type="range" min="0" max="1" value="0" class="slider" id="waterSlider">
                <span id="waterValue"></span>
            </div>
        </div>
        <div id="creepers" class="ib">
            <p>Creepers:</p>
            <div class="slidecontainer">
                <span>Width: </span>
                <input type="range" min="0.2" max="1" value="0.3" class="slider" id="creepersWidthSlider">
                <span id="creepersWidthValue"></span>
            </div>
            <div class="slidecontainer">
                <span>Height: </span>
                <input type="range" min="0.2" max="5" value="3" class="slider" id="creepersHeightSlider">
                <span id="creepersHeightValue"></span>
            </div>
            <div class="slidecontainer">
                <span>Spacing: </span>
                <input type="range" min="0.01" max="5" value="1" class="slider" id="creepersSpacingSlider">
                <span id="creepersSpacingValue"></span>
            </div>
            <form id="creepersType">
                <div>
                    Type:
                    <input id="rigid" type="radio" name="creepersType" value=false checked>
                    <label for="rigid">Rigid</label>

                    <input id="swingable" type="radio" name="creepersType" value=true>
                    <label for="swingable">Swingable</label>
                </div>
            </form>
        </div>
    </div>





</section>

</body>

<script>
    function init(cppn_input_vector, water_level, creepers_width, creepers_height, creepers_spacing, smoothing, creepers_type) {
        let canvas_id = 'main_screen2';

        window.game = new ParkourGame(config, canvas_id, cppn_input_vector, water_level, creepers_width, creepers_height, creepers_spacing, smoothing, creepers_type);
        window.game.env.set_zoom(zoomSlider.value);
        window.game.env.set_scroll(hScrollSlider.value, vScrollSlider.value);
        window.game.env.render();
    }

    async function loadModel(){
        window.cppn_model = await tf.loadGraphModel('./js/CPPN/weights/same_ground_ceiling_cppn/tfjs_model/model.json');
        let cppn_input_vector = [dim1Slider.value, dim2Slider.value, dim3Slider.value];
        init(cppn_input_vector, waterSlider.value, creepersWidthSlider.value, creepersHeightSlider.value, creepersSpacingSlider.value, smoothingSlider.value);
    }

    window.addEventListener("load", loadModel, false);

    /* BUTTONS AND SLIDERS */

    let runButton = document.getElementById("runButton");
    runButton.onclick = function (){
        this.innerText = window.game.run();
    }

    let resetButton = document.getElementById("resetButton");
    resetButton.onclick = function (){
        runButton.innerText = "Start";
        window.game.reset([dim1Slider.value, dim2Slider.value, dim3Slider.value],
                            waterSlider.value,
                            creepersWidthSlider.value,
                            creepersHeightSlider.value,
                            creepersSpacingSlider.value,
                            smoothingSlider.value,
                            getCreepersType());
    }

    // Horizontal scroll slider
    let hScrollSlider = document.getElementById("hScrollSlider");
    hScrollSlider.step = 0.1;
    //let hScrollValue = document.getElementById("hScrollValue");
    //hScrollValue.innerHTML = hScrollSlider.value; // Display the default slider value
    hScrollSlider.oninput = function() {
        //hScrollValue.innerHTML = this.value;
        window.game.env.set_scroll(this.value, vScrollSlider.value);
        window.game.env.render();
    }
    let resetHScroll = document.getElementById("resetHScroll");
    resetHScroll.onclick = function(){
        hScrollSlider.value = 0;
        //hScrollValue.innerHTML = "0";
        window.game.env.set_scroll(0, vScrollSlider.value);
        window.game.env.render();
    }

    // Vertical scroll slider
    let vScrollSlider = document.getElementById("vScrollSlider");
    vScrollSlider.step = 0.1;
    //let vScrollValue = document.getElementById("vScrollValue");
    //vScrollValue.innerHTML = vScrollSlider.value; // Display the default slider value
    vScrollSlider.oninput = function() {
        //vScrollValue.innerHTML = this.value;
        window.game.env.set_scroll(hScrollSlider.value, this.value);
        window.game.env.render();
    }
    let resetVScroll = document.getElementById("resetVScroll");
    resetVScroll.onclick = function(){
        vScrollSlider.value = 0;
        // vScrollValue.innerHTML = "0";
        window.game.env.set_scroll(hScrollSlider.value, 0);
        window.game.env.render();
    }

    // Zoom slider
    let zoomSlider = document.getElementById("zoomSlider");
    zoomSlider.step = 0.01;
    zoomSlider.value = 1;
    let zoomValue = document.getElementById("zoomValue");
    zoomValue.innerHTML = "x" + zoomSlider.value; // Display the default slider value
    zoomSlider.oninput = function() {
        zoomValue.innerHTML = "x" + this.value;
        window.game.env.set_zoom(this.value);
        window.game.env.set_scroll(hScrollSlider.value, vScrollSlider.value);
        window.game.env.render();
    }
    let resetZoom = document.getElementById("resetZoom");
    resetZoom.onclick = function(){
        zoomSlider.value = 1;
        zoomValue.innerHTML = "x1";
        window.game.env.set_zoom(1);
        window.game.env.set_scroll(hScrollSlider.value, vScrollSlider.value);
        window.game.env.render();
    }

    let jointsButton = document.getElementById("jointsButton");
    window.draw_joints = false;
    jointsButton.onclick = function (){
        window.draw_joints = !window.draw_joints;
        window.game.env.render();
    }

    let lidarsButton = document.getElementById("lidarsButton");
    window.draw_lidars = true;
    lidarsButton.onclick = function (){
        window.draw_lidars = !window.draw_lidars;
        window.game.env.render();
    }

    let followAgentButton = document.getElementById("followAgentButton");
    followAgentButton.onclick = function (){
        window.follow_agent = !window.follow_agent;
        window.game.env.render();
    }

    // CPPN encoding

    // dim1 slider
    let dim1Slider = document.getElementById("dim1Slider");
    dim1Slider.step = 0.01;
    dim1Slider.value = 0;
    let dim1Value = document.getElementById("dim1Value");
    dim1Value.innerHTML = dim1Slider.value; // Display the default slider value
    dim1Slider.oninput = function() {
        dim1Value.innerHTML = this.value;
        runButton.innerText = "Start";
        init([dim1Slider.value, dim2Slider.value, dim3Slider.value],
            waterSlider.value,
            creepersWidthSlider.value,
            creepersHeightSlider.value,
            creepersSpacingSlider.value,
            smoothingSlider.value,
            getCreepersType());
    }

    // dim2 slider
    let dim2Slider = document.getElementById("dim2Slider");
    dim2Slider.step = 0.01;
    dim2Slider.value = 0;
    let dim2Value = document.getElementById("dim2Value");
    dim2Value.innerHTML = dim2Slider.value; // Display the default slider value
    dim2Slider.oninput = function() {
        dim2Value.innerHTML = this.value;
        runButton.innerText = "Start";
        init([dim1Slider.value, dim2Slider.value, dim3Slider.value],
            waterSlider.value,
            creepersWidthSlider.value,
            creepersHeightSlider.value,
            creepersSpacingSlider.value,
            smoothingSlider.value,
            getCreepersType());
    }

    // dim3 slider
    let dim3Slider = document.getElementById("dim3Slider");
    dim3Slider.step = 0.01;
    dim3Slider.value = 0;
    let dim3Value = document.getElementById("dim3Value");
    dim3Value.innerHTML = dim3Slider.value; // Display the default slider value
    dim3Slider.oninput = function() {
        dim3Value.innerHTML = this.value;
        runButton.innerText = "Start";
        init([dim1Slider.value, dim2Slider.value, dim3Slider.value],
            waterSlider.value,
            creepersWidthSlider.value,
            creepersHeightSlider.value,
            creepersSpacingSlider.value,
            smoothingSlider.value,
            getCreepersType());
    }

    // water slider
    let waterSlider = document.getElementById("waterSlider");
    waterSlider.step = 0.01;
    waterSlider.value = 0;
    let waterValue = document.getElementById("waterValue");
    waterValue.innerHTML = waterSlider.value; // Display the default slider value
    waterSlider.oninput = function() {
        waterValue.innerHTML = this.value;
        runButton.innerText = "Start";
        init([dim1Slider.value, dim2Slider.value, dim3Slider.value],
            waterSlider.value,
            creepersWidthSlider.value,
            creepersHeightSlider.value,
            creepersSpacingSlider.value,
            smoothingSlider.value,
            getCreepersType());
    }

    // creepersWidth slider
    let creepersWidthSlider = document.getElementById("creepersWidthSlider");
    creepersWidthSlider.step = 0.01;
    creepersWidthSlider.value = 0.3;
    let creepersWidthValue = document.getElementById("creepersWidthValue");
    creepersWidthValue.innerHTML = creepersWidthSlider.value; // Display the default slider value
    creepersWidthSlider.oninput = function() {
        creepersWidthValue.innerHTML = this.value;
        runButton.innerText = "Start";
        init([dim1Slider.value, dim2Slider.value, dim3Slider.value],
            waterSlider.value,
            creepersWidthSlider.value,
            creepersHeightSlider.value,
            creepersSpacingSlider.value,
            smoothingSlider.value,
            getCreepersType());
    }

    // creepersHeight slider
    let creepersHeightSlider = document.getElementById("creepersHeightSlider");
    creepersHeightSlider.step = 0.01;
    creepersHeightSlider.value = 3;
    let creepersHeightValue = document.getElementById("creepersHeightValue");
    creepersHeightValue.innerHTML = creepersHeightSlider.value; // Display the default slider value
    creepersHeightSlider.oninput = function() {
        creepersHeightValue.innerHTML = this.value;
        runButton.innerText = "Start";
        init([dim1Slider.value, dim2Slider.value, dim3Slider.value],
            waterSlider.value,
            creepersWidthSlider.value,
            creepersHeightSlider.value,
            creepersSpacingSlider.value,
            smoothingSlider.value,
            getCreepersType());
    }

    // creepersSpacing slider
    let creepersSpacingSlider = document.getElementById("creepersSpacingSlider");
    creepersSpacingSlider.step = 0.01;
    creepersSpacingSlider.value = 1;
    let creepersSpacingValue = document.getElementById("creepersSpacingValue");
    creepersSpacingValue.innerHTML = creepersSpacingSlider.value; // Display the default slider value
    creepersSpacingSlider.oninput = function() {
        creepersSpacingValue.innerHTML = this.value;
        runButton.innerText = "Start";
        init([dim1Slider.value, dim2Slider.value, dim3Slider.value],
            waterSlider.value,
            creepersWidthSlider.value,
            creepersHeightSlider.value,
            creepersSpacingSlider.value,
            smoothingSlider.value,
            getCreepersType());
    }

    // smoothing slider
    let smoothingSlider = document.getElementById("smoothingSlider");
    smoothingSlider.step = 0.01;
    smoothingSlider.value = 15;
    let smoothingValue = document.getElementById("smoothingValue");
    smoothingValue.innerHTML = smoothingSlider.value; // Display the default slider value
    smoothingSlider.oninput = function() {
        smoothingValue.innerHTML = this.value;
        runButton.innerText = "Start";
        init([dim1Slider.value, dim2Slider.value, dim3Slider.value],
            waterSlider.value,
            creepersWidthSlider.value,
            creepersHeightSlider.value,
            creepersSpacingSlider.value,
            smoothingSlider.value,
            getCreepersType());
    }

    function getCreepersType(){
        let data = new FormData(creepersTypeForm);
        let output = "";
        for (const entry of data) {
            output = entry[1];
        };
        return output == 'true';
    }

    // Creeper Type form
   let creepersTypeForm = document.getElementById("creepersType");
    creepersTypeForm.onclick = function (){
        init([dim1Slider.value, dim2Slider.value, dim3Slider.value],
            waterSlider.value,
            creepersWidthSlider.value,
            creepersHeightSlider.value,
            creepersSpacingSlider.value,
            smoothingSlider.value,
            getCreepersType());
    }


</script>



</html>